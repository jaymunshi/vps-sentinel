#!/bin/bash
# VPS Sentinel - Restore firewall rules on boot

# Load saved rules
iptables-restore < /etc/iptables/rules.v4 2>/dev/null || true
ip6tables-restore < /etc/iptables/rules.v6 2>/dev/null || true

# Load permanent blacklist
if [ -f /etc/sentinel/permanent_blacklist.txt ]; then
    while IFS= read -r ip; do
        [[ "$ip" =~ ^#.*$ ]] && continue
        [[ -z "$ip" ]] && continue
        iptables -I INPUT -s "$ip" -j DROP 2>/dev/null
    done < /etc/sentinel/permanent_blacklist.txt
fi

# Basic protection rules
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -p tcp --dport 22 -m recent --update --seconds 60 --hitcount 4 --name SSH -j DROP
iptables -A INPUT -p tcp --dport 22 -m recent --set --name SSH
iptables -A INPUT -p icmp --icmp-type echo-request -m limit --limit 1/s -j ACCEPT
iptables -A INPUT -p tcp --tcp-flags ALL NONE -j DROP
iptables -A INPUT -p tcp --tcp-flags ALL ALL -j DROP
