#!/bin/bash
# VPS Sentinel - Live Router/IoT Exploit Monitor

CONF="/etc/sentinel/sentinel.conf"
[ -f "$CONF" ] && source "$CONF" || { echo "Config not found: $CONF"; exit 1; }

echo "  Router/IoT Exploit Monitor - Live Feed"
echo "======================================================================="
echo "Press Ctrl+C to exit"
echo ""

tail -f "$EXPLOIT_LOG" | while IFS= read -r line; do
    [[ -z "$line" ]] && continue

    IP=$(echo "$line" | awk '{print $1}')
    TIMESTAMP=$(echo "$line" | awk '{print $4" "$5}' | tr -d '[]')
    EPATH=$(echo "$line" | awk '{print $7}')

    if [[ "$IP" != "::1" ]] && [[ "$IP" != "127.0.0.1" ]]; then
        COUNTRY=$(geoiplookup "$IP" 2>/dev/null | grep "GeoIP Country" | cut -d ":" -f2 | cut -d "," -f2 | sed 's/^ *//;s/ *$//')
    else
        COUNTRY="Localhost"
    fi

    # Color code based on path
    if [[ "$EPATH" =~ "boaform" ]]; then
        COLOR="\033[31m"; TYPE="BOAFORM"
    elif [[ "$EPATH" =~ "luci" ]]; then
        COLOR="\033[33m"; TYPE="LUCI"
    elif [[ "$EPATH" =~ "GponForm" ]]; then
        COLOR="\033[35m"; TYPE="GPON"
    elif [[ "$EPATH" =~ "setup.cgi" ]] || [[ "$EPATH" =~ "login.cgi" ]]; then
        COLOR="\033[36m"; TYPE="CGI"
    else
        COLOR="\033[37m"; TYPE="OTHER"
    fi

    echo -e "${COLOR}[${TIMESTAMP}] ${TYPE} | ${IP} (${COUNTRY:-Unknown}) | ${EPATH}\033[0m"
done
