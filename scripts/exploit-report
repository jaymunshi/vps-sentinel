#!/bin/bash
# VPS Sentinel - Router/IoT Exploit Detailed Report
# BUG FIX: Fixed subshell counter bug â€” UNBLOCKED_COUNT now tracks correctly

CONF="/etc/sentinel/sentinel.conf"
[ -f "$CONF" ] && source "$CONF" || { echo "Config not found: $CONF"; exit 1; }

echo "======================================================================="
echo "         ROUTER/IOT EXPLOIT DETAILED REPORT"
echo "======================================================================="
echo "Generated: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

if [[ ! -f "$EXPLOIT_LOG" ]]; then
    echo "No exploit attempts logged yet - system is clean!"
    exit 0
fi

FIRST_ENTRY=$(head -1 "$EXPLOIT_LOG" | awk '{print $4" "$5}' | tr -d '[]')
LAST_ENTRY=$(tail -1 "$EXPLOIT_LOG" | awk '{print $4" "$5}' | tr -d '[]')
TOTAL_ATTEMPTS=$(wc -l < "$EXPLOIT_LOG")

echo "  OVERVIEW"
echo "-----------------------------------------------------------------------"
echo "  First attempt : $FIRST_ENTRY"
echo "  Latest attempt: $LAST_ENTRY"
echo "  Total blocked : $TOTAL_ATTEMPTS attempts"
echo ""

echo "  EXPLOIT BREAKDOWN"
echo "-----------------------------------------------------------------------"
BOAFORM_COUNT=$(grep -c "boaform" "$EXPLOIT_LOG")
LUCI_COUNT=$(grep -c "luci" "$EXPLOIT_LOG")
GPON_COUNT=$(grep -c "GponForm" "$EXPLOIT_LOG")
SETUP_COUNT=$(grep -c "setup\.cgi" "$EXPLOIT_LOG")
LOGIN_COUNT=$(grep -c "login\.cgi" "$EXPLOIT_LOG")
MANAGER_COUNT=$(grep -c "manager/html" "$EXPLOIT_LOG")

[ "$TOTAL_ATTEMPTS" -eq 0 ] && TOTAL_ATTEMPTS=1  # avoid division by zero
printf "  %-15s: %5d attempts (%d%%)\n" "Boaform" "$BOAFORM_COUNT" "$((BOAFORM_COUNT * 100 / TOTAL_ATTEMPTS))"
printf "  %-15s: %5d attempts (%d%%)\n" "LuCI (OpenWrt)" "$LUCI_COUNT" "$((LUCI_COUNT * 100 / TOTAL_ATTEMPTS))"
printf "  %-15s: %5d attempts (%d%%)\n" "GponForm" "$GPON_COUNT" "$((GPON_COUNT * 100 / TOTAL_ATTEMPTS))"
printf "  %-15s: %5d attempts (%d%%)\n" "Setup CGI" "$SETUP_COUNT" "$((SETUP_COUNT * 100 / TOTAL_ATTEMPTS))"
printf "  %-15s: %5d attempts (%d%%)\n" "Login CGI" "$LOGIN_COUNT" "$((LOGIN_COUNT * 100 / TOTAL_ATTEMPTS))"
printf "  %-15s: %5d attempts (%d%%)\n" "Manager HTML" "$MANAGER_COUNT" "$((MANAGER_COUNT * 100 / TOTAL_ATTEMPTS))"
echo ""

echo "  MOST AGGRESSIVE ATTACKERS"
echo "-----------------------------------------------------------------------"
awk '{print $1}' "$EXPLOIT_LOG" | sort | uniq -c | sort -rn | head -10 | while read count ip; do
    if [[ "$ip" != "::1" ]] && [[ "$ip" != "127.0.0.1" ]]; then
        COUNTRY=$(geoiplookup "$ip" 2>/dev/null | grep "GeoIP Country" | cut -d ":" -f2 | cut -d "," -f2 | sed 's/^ *//;s/ *$//')
    else
        COUNTRY="Localhost"
    fi
    BLOCKED=$(sudo iptables -L -n 2>/dev/null | grep -q "$ip" && echo "BLOCKED" || echo "NOT BLOCKED")
    printf "  %3d attempts | %-16s | %-20s | %s\n" "$count" "$ip" "${COUNTRY:-Unknown}" "$BLOCKED"
done
echo ""

echo "  RECENT ACTIVITY (Last 10 attempts)"
echo "-----------------------------------------------------------------------"
tail -10 "$EXPLOIT_LOG" | while IFS= read -r line; do
    IP=$(echo "$line" | awk '{print $1}')
    TIMESTAMP=$(echo "$line" | awk '{print $4" "$5}' | tr -d '[]')
    EPATH=$(echo "$line" | awk '{print $7}')
    echo "  [$TIMESTAMP] $IP -> $EPATH"
done
echo ""

echo "  RECOMMENDATIONS"
echo "-----------------------------------------------------------------------"
# BUG FIX: Use temp file instead of subshell pipeline so counter works
UNBLOCKED_COUNT=0
TMPFILE=$(mktemp)
awk '{print $1}' "$EXPLOIT_LOG" | sort | uniq -c | sort -rn | awk '$1 > 3 {print $2}' > "$TMPFILE"

while read ip; do
    if ! sudo iptables -L -n 2>/dev/null | grep -q "$ip"; then
        UNBLOCKED_COUNT=$((UNBLOCKED_COUNT + 1))
    fi
done < "$TMPFILE"
rm -f "$TMPFILE"

if [[ $UNBLOCKED_COUNT -gt 0 ]]; then
    echo "  Found $UNBLOCKED_COUNT aggressive IPs (3+ attempts) not yet blocked"
    echo "  -> Run 'srun' to update blocks"
else
    echo "  All aggressive attackers are blocked"
fi

LOG_SIZE=$(du -b "$EXPLOIT_LOG" 2>/dev/null | cut -f1)
if [[ "${LOG_SIZE:-0}" -gt 10485760 ]]; then
    echo "  Log file is large (>10MB) - consider rotation"
else
    echo "  Log file size is healthy"
fi
echo ""
