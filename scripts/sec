#!/bin/bash
# VPS Sentinel - Quick Security Status (runs on login)

CONF="/etc/sentinel/sentinel.conf"
[ -f "$CONF" ] && source "$CONF" || { echo "Config not found: $CONF"; exit 1; }

echo "======================================================================="
echo "         ${PROJECT_NAME} - SECURITY STATUS"
echo "======================================================================="
echo ""
echo "  Protection Status:"
echo "   Blocked IPs: $(sudo iptables-save 2>/dev/null | grep -c '^-A INPUT.*DROP')"
echo "   Fail2ban: $(sudo fail2ban-client status 2>/dev/null | grep 'Number of jail' || echo 'Not running')"
echo "   Last scan: $(grep "completed" "$SENTINEL_LOG" 2>/dev/null | tail -1 | cut -d' ' -f1-2 | tr -d '[]')"
echo ""
echo "  Current Threats:"
echo "   SSH attacks (last hour):"
sudo grep "$(date '+%b %e %H')" "$AUTH_LOG" 2>/dev/null | grep -E "Failed password|Invalid user" | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | sort | uniq -c | sort -rn | head -3 | while read count ip; do
    echo "      $ip: $count attempts"
done || echo "      None detected"
echo ""
echo "  System Health:"
echo "   Nginx log: $(du -h "$NGINX_LOG" 2>/dev/null | cut -f1)"
echo "   Auth log: $(du -h "$AUTH_LOG" 2>/dev/null | cut -f1)"
echo "   Load: $(uptime | awk -F'load average:' '{print $2}')"
echo ""
echo "  Recent Actions:"
tail -3 "$BLOCKED_LOG" 2>/dev/null | while read line; do
    echo "   $line" | cut -d'|' -f1,2
done || echo "   No recent blocks"
echo ""
echo "  Schedule:"
echo "   Next scan: $(systemctl list-timers sentinel.timer --no-pager 2>/dev/null | grep sentinel | awk '{print $1, $2, $3}')"
echo ""
echo "======================================================================="
echo "  Commands: check-ip <IP> | security-dashboard | srun (manual scan)"
echo "======================================================================="
