#!/bin/bash
# VPS Sentinel - Router/IoT Exploit Statistics

CONF="/etc/sentinel/sentinel.conf"
[ -f "$CONF" ] && source "$CONF" || { echo "Config not found: $CONF"; exit 1; }

echo "  Router/IoT Exploit Statistics"
echo "======================================================================="
echo ""

if [[ ! -f "$EXPLOIT_LOG" ]]; then
    echo "No exploit log file found yet."
    exit 0
fi

TODAY=$(date '+%d/%b/%Y')

echo "  Today's Stats ($TODAY):"
echo "-----------------------------------------------------------------------"
TODAY_COUNT=$(grep "$TODAY" "$EXPLOIT_LOG" 2>/dev/null | wc -l)
echo "  Total blocked: $TODAY_COUNT attempts"

if [[ $TODAY_COUNT -gt 0 ]]; then
    echo ""
    echo "  By exploit type:"
    echo "    Boaform:    $(grep "$TODAY" "$EXPLOIT_LOG" | grep -c "boaform")"
    echo "    LuCI:       $(grep "$TODAY" "$EXPLOIT_LOG" | grep -c "luci")"
    echo "    GponForm:   $(grep "$TODAY" "$EXPLOIT_LOG" | grep -c "GponForm")"
    echo "    Setup CGI:  $(grep "$TODAY" "$EXPLOIT_LOG" | grep -c "setup\.cgi")"
    echo "    Login CGI:  $(grep "$TODAY" "$EXPLOIT_LOG" | grep -c "login\.cgi")"
    echo "    Manager:    $(grep "$TODAY" "$EXPLOIT_LOG" | grep -c "manager/html")"

    echo ""
    echo "  Top attacking IPs today:"
    grep "$TODAY" "$EXPLOIT_LOG" | awk '{print $1}' | sort | uniq -c | sort -rn | head -5 | while read count ip; do
        if [[ "$ip" != "::1" ]] && [[ "$ip" != "127.0.0.1" ]]; then
            COUNTRY=$(geoiplookup "$ip" 2>/dev/null | grep "GeoIP Country" | cut -d ":" -f2 | cut -d "," -f2 | sed 's/^ *//;s/ *$//')
        else
            COUNTRY="Localhost"
        fi
        printf "    %-4s attempts from %-16s (%s)\n" "$count" "$ip" "${COUNTRY:-Unknown}"
    done
fi

echo ""
echo "  Last 7 Days Overview:"
echo "-----------------------------------------------------------------------"
for i in {0..6}; do
    DATE=$(date -d "$i days ago" '+%d/%b/%Y' 2>/dev/null || date -v-${i}d '+%d/%b/%Y' 2>/dev/null)
    COUNT=$(grep "$DATE" "$EXPLOIT_LOG" 2>/dev/null | wc -l)
    printf "  %s: %3d attempts\n" "$DATE" "$COUNT"
done

echo ""
echo "  All-Time Top Countries:"
echo "-----------------------------------------------------------------------"
awk '{print $1}' "$EXPLOIT_LOG" | sort -u | while read ip; do
    if [[ "$ip" != "::1" ]] && [[ "$ip" != "127.0.0.1" ]]; then
        geoiplookup "$ip" 2>/dev/null | grep "GeoIP Country" | cut -d ":" -f2 | cut -d "," -f2 | sed 's/^ *//;s/ *$//'
    fi
done | sort | uniq -c | sort -rn | head -5 | while read count country; do
    [[ -n "$country" ]] && printf "  %-4s attempts from %s\n" "$count" "$country"
done

echo ""
echo "  Log file size: $(du -h "$EXPLOIT_LOG" 2>/dev/null | cut -f1)"
